{% extends 'generic/object.html' %}
{% load render_table from django_tables2 %}

{% block content %}
<style>
    .mermaid {
        width: 100% !important;
        text-align: center;
    }
    .mermaid svg {
        width: 100% !important;
        display: inline-block;
    }
</style>

<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
</script>

<div class="row mb-3">
<div class="col col-md-5">
<div class="card">
    <h5 class="card-header">Details</h5>
    <div class="card-body">
        <table class="table table-hover attr-table">
            {% for field in field_data %}
                <tr>
                    <th scope="row">{{ field.name|title }}</th>
                    <td>
                        {% if field.url %}
                            <a href="{{ field.url }}">{{ field.value }}</a>
                        {% else %}
                            {{ field.value }}
                        {% endif %}
                    </td>
                </tr> 
            {% endfor %}
        </table>
    </div>
</div>
</div>
<div class="col col-md-12">
{% for related_table in related_tables %}
    <div class="card">
        <h5 class="card-header d-flex justify-content-between align-items-center">
            <span>{{ related_table.name|title }}</span>
            {% if related_table.add_url %}
                <a href="{{ related_table.add_url }}" class="btn btn-sm btn-primary">
                    <i class="mdi mdi-plus"></i> Add
                </a>
            {% endif %}
        </h5>
        <div class="card-body">
                {% render_table related_table.table %}
        </div>
    </div>
{% endfor %}
</div>
<div class="row mb-3">
    <div class="card mt-3">
        <!-- <h5 class="card-header">Relationship Diagram</h5> -->       
        <div class="card-body">
            <div id="control-bar">
                <label for="layout">Layout:</label>
                <select id="layout">
                    <option value="TD">Top-Down</option>
                    <option value="LR">Left-Right</option>
                </select>
                <div id="subgraph-toggles"></div>
            </div>
            <div class="mermaid" style="width: 100%; overflow-y: auto;">
                <div class="mermaid-diagram">
                {{ mermaid_diagram }}
                </div>
            </div>
            <div class="mermaid" style="width: 100%;">
                {{ mermaid_legend }}
            </div>
        </div>
    </div>
    <div class="card mt-3">
        <div class="card-header">
            Mermaid Diagram Definition
        </div>
        <div class="card-body">
            <pre>{{ mermaid_diagram }}</pre>
        </div>
    </div>
 </div>
</div>   
</div>
<script>
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
    
    document.getElementById('layout').addEventListener('change', renderDiagram);
    let hiddenSubgraphs = new Set();
    
    // Assume `diagramData` is the variable containing the Mermaid definition sent from the server
    let originalDiagram = `{{ mermaid_diagram }}`;
    
    function renderDiagram() {
        const layout = document.getElementById('layout').value;
        // Replace the layout in the original diagram definition
        let updatedDiagram = originalDiagram.replace(/graph (TD|LR)/, `graph ${layout}`);
    
        // Dynamically hide subgraphs
        hiddenSubgraphs.forEach(subgraph => {
            const regex = new RegExp(`subgraph\\s+${subgraph}[^}]+end`, 'g');
            updatedDiagram = updatedDiagram.replace(regex, '');
        });
    
        // Render the diagram using Mermaid
        mermaid.render('mermaid-diagram', updatedDiagram, (svgCode) => {
            document.getElementById('mermaid-diagram').innerHTML = svgCode;
        });
    }
    
    function extractSubgraphNames(data) {
    const subgraphNames = [];
    const regex = /subgraph\s+([^\s]+)\s+\[(.*?)\]/g;  // Matches "subgraph subgraph_id [Display Name]"
    let match;
    
    while ((match = regex.exec(data)) !== null) {
        subgraphNames.push({
            id: match[1],         // e.g., "hiddenName"
            displayName: match[2] // e.g., "Display Name"
        });
    }
    return subgraphNames;
}

// Usage in createSubgraphToggles()
function createSubgraphToggles() {
    const subgraphNames = extractSubgraphNames(originalDiagram);
    const togglesContainer = document.getElementById('subgraph-toggles');
    togglesContainer.innerHTML = '';

    subgraphNames.forEach(({ id, displayName }) => {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = true;
        checkbox.id = `toggle-${id}`;
        checkbox.addEventListener('change', () => toggleSubgraph(id));

        const label = document.createElement('label');
        label.textContent = `Show ${displayName}`;
        label.htmlFor = `toggle-${id}`;

        togglesContainer.appendChild(checkbox);
        togglesContainer.appendChild(label);
        togglesContainer.appendChild(document.createElement('br'));
    });
}
    
    function toggleSubgraph(subgraph) {
        const checkbox = document.getElementById(`toggle-${subgraph}`);
        if (checkbox.checked) {
            hiddenSubgraphs.delete(subgraph);
        } else {
            hiddenSubgraphs.add(subgraph);
        }
        renderDiagram();
    }
// Initialize the controls and render the initial diagram
createSubgraphToggles();
renderDiagram();
</script>
{% endblock %}
